generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  //schemas = ["voucher"]
}

model Campaign {

  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String?
  prefix      String
  amountCents Int      @map("amount_cents")
  currency    String   @db.Char(3)
  validFrom   DateTime @map("valid_from")
  validTo     DateTime @map("valid_to")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  vouchers Voucher[]
  batches  GenerationBatch[]

  @@index([prefix], map: "ix_campaign_prefix")
  @@index([createdAt], map: "ix_campaign_created_at")
  @@map("campaign")
}

model Voucher {

  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  campaignId String   @map("campaign_id") @db.Uuid
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  code       String   @unique
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([campaignId], map: "ix_voucher_campaign_id")
  @@index([createdAt], map: "ix_voucher_created_at")
  @@map("voucher")
}

model GenerationBatch {

  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  campaignId     String   @map("campaign_id") @db.Uuid
  campaign       Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  requestedCount Int      @map("requested_count")
  generatedCount Int      @map("generated_count")
  durationMs     Int?     @map("duration_ms")
  status         String
  createdAt      DateTime @default(now()) @map("created_at")

  @@index([campaignId], map: "ix_batch_campaign_id")
  @@index([createdAt], map: "ix_batch_created_at")
  @@map("generation_batch")
}
